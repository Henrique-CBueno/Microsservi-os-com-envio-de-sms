# Sistema de AnÃ¡lise de CrÃ©dito com MicroserviÃ§os Orientado a Eventos

Sistema de anÃ¡lise de crÃ©dito baseado em eventos, construÃ­do com Spring Boot 3, arquitetura de microserviÃ§os e mensageria assÃ­ncrona, simulando um cenÃ¡rio real de produÃ§Ã£o com **notificaÃ§Ãµes SMS via AWS SNS**, processamento paralelo e atualizaÃ§Ãµes em tempo real.

## ğŸ“‹ Arquitetura

O sistema Ã© composto por **3 microserviÃ§os** orquestrados via Docker Compose, mais um frontend e infraestrutura de suporte:

### MicroserviÃ§os

- **proposta-app** (porta 8080)
  - ServiÃ§o principal responsÃ¡vel pelo recebimento e gerenciamento de propostas
  - IntegraÃ§Ã£o com banco de dados PostgreSQL
  - WebSocket para notificaÃ§Ãµes em tempo real ao frontend
  - Agendamento de tarefas com `@Scheduled`
  - ExpÃµe REST API para o frontend

- **analise-credito**
  - AnÃ¡lise de crÃ©dito com regras de negÃ³cio baseadas em Design Pattern Strategy
  - Processamento paralelo de mÃºltiplas propostas
  - CÃ¡lculo de pontuaÃ§Ã£o com mÃºltiplos critÃ©rios
  - Consome mensagens de fila de propostas pendentes

- **notificacao**
  - IntegraÃ§Ã£o com AWS SNS para envio de SMS
  - Notifica cliente conforme a anÃ¡lise avanÃ§a
  - Recebe eventos de proposta pendente e concluÃ­da

### Infraestrutura

- **PostgreSQL** - Banco de dados de propostas
- **RabbitMQ** - Message broker com interface de gerenciamento
- **proposta-web-front** - Frontend em React/Angular consumindo a API

## ğŸš€ Quick Start

### PrÃ©-requisitos

- Docker & Docker Compose
- Java 17+ (para desenvolvimento local)
- Maven 3.8.7+

### Iniciar o Sistema Completo

```bash
docker compose up -d
```

O Docker Compose realiza:

1. **Build automÃ¡tico** de todos os microserviÃ§os (compila com Maven `-DskipTests`)
2. **Cria imagens** Docker otimizadas com multi-stage build
3. **Orquestra containers** com dependÃªncias corretas
4. **Inicializa bancos** de dados e message broker

### Endpoints Principais

#### Proposta App (http://localhost:8080)

```bash
# Criar nova proposta
POST /proposta
Content-Type: application/json

{
  "cliente": "JoÃ£o Silva",
  "cpf": "123.456.789-00",
  "renda": 5000.00,
  "valorSolicitado": 10000.00,
  "prazoPagamento": 24
}

# Listar todas as propostas
GET /proposta
```

#### Frontend

```
http://localhost:80
```

## ğŸ—ï¸ Arquitetura TÃ©cnica Detalhada

### 1. **ComunicaÃ§Ã£o AssÃ­ncrona - RabbitMQ**

#### Topologia de Filas e Exchanges

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Exchanges (Fanout)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ proposta-pendente  â”‚ proposta-concluida    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Propostas    â”‚      â”‚ Propostas    â”‚
  â”‚ Pendentes    â”‚      â”‚ ConcluÃ­das   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ms-analise-credito                  â”‚
  â”‚ ms-notificacao                      â”‚
  â”‚ ms-proposta                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Fluxo de Mensagens

1. **Proposta Criada** â†’ `proposta-pendente` exchange
   - Routing: `proposta-pendente.ms-analise-credito`
   - Routing: `proposta-pendente.ms-notificacao`
   - Routing: `proposta-pendente.ms-proposta`

2. **AnÃ¡lise ConcluÃ­da** â†’ `proposta-concluida` exchange
   - Routing: `proposta-concluida.ms-notificacao`
   - Routing: `proposta-concluida.ms-proposta`

#### Dead Letter Queues (DLQ)

Propostas com erro sÃ£o redireccionadas para:

- `proposta-pendente.dlq` - Falhas em anÃ¡lise
- `proposta-concluida.dlq` - Falhas na conclusÃ£o

**ConfiguraÃ§Ã£o em cada serviÃ§o:**

```properties
spring.rabbitmq.host=rabbit-mq
spring.rabbitmq.port=5672
spring.rabbitmq.listener.simple.retry.enabled=true
spring.rabbitmq.listener.simple.retry.max-attempts=3
```

### 2. **Design Pattern Strategy - AnÃ¡lise de CrÃ©dito**

A anÃ¡lise usa mÃºltiplos critÃ©rios aplicados em sequÃªncia:

```java
// Interface base
public interface CalculoPonto {
    int calcularPonto(Proposta proposta);
}

// ImplementaÃ§Ãµes
- RendaMaiorValorSolicitadoImpl
  â€¢ Verifica se renda > valor solicitado

- PrazoPagamentoMenorDezAnosImpl
  â€¢ Verifica prazo de pagamento < 10 anos

- PontuacaoScoreImpl
  â€¢ Calcula score baseado em mÃºltiplos fatores
```

**OrquestraÃ§Ã£o com @Order:**

```java
@Component
@Order(1)  // Executa primeiro
public class RendaMaiorValorSolicitadoImpl implements CalculoPonto { }

@Component
@Order(2)  // Executa segundo
public class PrazoPagamentoMenorDezAnosImpl implements CalculoPonto { }
```

Os critÃ©rios sÃ£o aplicados paralelamente via `@RabbitListener` com mÃºltiplos consumers.

### 3. **WebSocket - NotificaÃ§Ãµes em Tempo Real**

#### ConfiguraÃ§Ã£o

```java
@Configuration
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    // Endpoints WebSocket
    // /ws - Cliente se conecta
    // /topic/propostas - TÃ³pico de broadcast
}
```

#### Fluxo

1. Frontend conecta ao `/ws`
2. ServiÃ§o envia atualizaÃ§Ãµes via `SimpMessagingTemplate`
3. Todos os clientes recebem notificaÃ§Ãµes em tempo real

```javascript
// Frontend (exemplo)
const stompClient = new StompClient("ws://localhost:8080/ws");
stompClient.subscribe("/topic/propostas", (message) => {
  // Atualiza UI com novo status
});
```

### 4. **PersistÃªncia - PostgreSQL + JPA/Hibernate**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Proposta   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚ PK
â”‚ cliente      â”‚
â”‚ cpf          â”‚
â”‚ renda        â”‚
â”‚ valorSolicitado
â”‚ prazoPagamento
â”‚ status       â”‚ (PENDENTE, EM_ANALISE, APROVADA, REJEITADA)
â”‚ createdAt    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ConfiguraÃ§Ãµes:**

```properties
spring.datasource.url=jdbc:postgresql://postgres:5432/docker
spring.jpa.hibernate.ddl-auto=update
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
```

### 5. **AWS SNS - IntegraÃ§Ã£o SMS**

O serviÃ§o de notificaÃ§Ã£o envia SMS para o cliente via AWS SNS:

```java
@Service
public class NotificacaoSmsService {
    private final AmazonSNS amazonSNS;

    public void enviarSms(String numeroTelefone, String mensagem) {
        // Envia SMS via SNS
    }
}
```

**ConfiguraÃ§Ã£o em produÃ§Ã£o:**

```properties
aws.accessKey=${AWS_ACCESS_KEY}
aws.secretKey=${AWS_SECRET_KEY}
aws.region=us-east-1
aws.sns.endpoint=https://sns.us-east-1.amazonaws.com
```

### 6. **Agendamento - @Scheduled**

O `proposta-app` possui tarefas agendadas:

```java
@SpringBootApplication
@EnableScheduling
public class PropostaAppApplication { }

@Service
public class PropostaService {

    @Scheduled(fixedDelay = 60000)  // A cada 1 minuto
    public void verificarPropostasAtrasadas() {
        // LÃ³gica de verificaÃ§Ã£o
    }
}
```

### 7. **Data Transfer Objects (DTOs) + MapStruct**

```java
// Request DTO
public record PropostaCreateReqDTO(
    String cliente,
    String cpf,
    BigDecimal renda,
    BigDecimal valorSolicitado,
    Integer prazoPagamento
) {}

// Response DTO
public record PropostaCreateResDTO(
    Long id,
    String status,
    LocalDateTime criada
) {}

// Mapeador
@Mapper(componentModel = "spring")
public interface PropostaMapper {
    PropostaCreateResDTO toDTO(Proposta proposta);
    Proposta toEntity(PropostaCreateReqDTO dto);
}
```

### 8. **CORS - Cross-Origin Resource Sharing**

```java
@Configuration
public class CorsConfiguration {

    @Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**")
                    .allowedOrigins("http://localhost:3000")  // Frontend
                    .allowedMethods("GET", "POST", "PUT", "DELETE")
                    .allowedHeaders("*");
            }
        };
    }
}
```

### 9. **ResiliÃªncia na AplicaÃ§Ã£o**

- **Retry AutomÃ¡tico:** RabbitMQ com `retry.max-attempts=3`
- **Dead Letter Queue:** Propostas com erro sÃ£o redirecionadas
- **Health Check:** RabbitMQ com `healthcheck` no compose
- **Dependencies Management:** Containers aguardam dependÃªncias inicializarem

## ğŸ“¦ Stack TecnolÃ³gico

```
Spring Boot 3.5.10
â”œâ”€â”€ Spring Web (REST API)
â”œâ”€â”€ Spring Data JPA (PersistÃªncia)
â”œâ”€â”€ Spring AMQP (RabbitMQ)
â”œâ”€â”€ Spring WebSocket
â””â”€â”€ Spring Scheduling

Banco de Dados & Message Broker
â”œâ”€â”€ PostgreSQL 15
â””â”€â”€ RabbitMQ 3.12

Utilities
â”œâ”€â”€ Lombok (ReduÃ§Ã£o de boilerplate)
â”œâ”€â”€ MapStruct (Mapeamento de DTOs)
â”œâ”€â”€ Jackson (JSON serialization)
â””â”€â”€ AWS SDK SNS (Envio de SMS)

Build & Deploy
â”œâ”€â”€ Maven 3.8.7
â”œâ”€â”€ Docker (Multi-stage builds)
â””â”€â”€ Docker Compose (OrquestraÃ§Ã£o)
```

## ğŸ”§ ConfiguraÃ§Ã£o de Perfis

### Desenvolvimento (Default)

```properties
# application.properties
spring.rabbitmq.host=localhost
spring.datasource.url=jdbc:postgresql://localhost:5432/docker
aws.sns.endpoint=http://localhost:4566  # LocalStack
```

### ProduÃ§Ã£o

```properties
# application-prod.properties
spring.rabbitmq.host=rabbit-mq        # Nome do serviÃ§o no compose
spring.datasource.url=jdbc:postgresql://postgres:5432/docker
aws.sns.endpoint=https://sns.us-east-1.amazonaws.com
```

**AtivaÃ§Ã£o:**

```bash
# Via variÃ¡vel de ambiente
docker compose up  # SPRING_PROFILES_ACTIVE=prod

# Ou manualmente
java -jar app.jar --spring.profiles.active=prod
```

## ğŸ³ Docker & Compose

### Multi-stage Dockerfile

```dockerfile
# EstÃ¡gio 1: Build
FROM maven:3.8.7-eclipse-temurin-17 AS build
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# EstÃ¡gio 2: Runtime
FROM eclipse-temurin:17-jdk
COPY --from=build /app/target/*.jar app.jar
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

**Vantagens:**

- Sempre compila com cÃ³digo atualizado
- Pula testes com `-DskipTests` para velocidade
- Imagem final enxuta (apenas JDK + JAR)

### OrquestraÃ§Ã£o

```yaml
services:
  proposta-app:
    build: ./proposta-app
    depends_on:
      rabbit-mq:
        condition: service_healthy
      postgres:
        condition: service_started
```

## ğŸ“Š Fluxo Completo de Uma Proposta

```
1. Cliente submete proposta
   â†“
2. proposta-app recebe POST /proposta
   â”œâ”€ Persiste no PostgreSQL
   â””â”€ Publica em proposta-pendente exchange

3. RabbitMQ distribui para 3 consumers
   â”œâ”€ analise-credito (aplica regras)
   â”œâ”€ notificacao (prepara SMS)
   â””â”€ ms-proposta (atualiza status)

4. analise-credito processa
   â””â”€ Aplica estratÃ©gias em paralelo

5. Resultado retorna via proposta-concluida exchange
   â”œâ”€ notificacao envia SMS via AWS SNS
   â”œâ”€ proposta-app atualiza PostgreSQL
   â””â”€ WebSocket notifica frontend em tempo real
```

## ğŸ” SeguranÃ§a

- âœ… CORS configurado
- âœ… Retry automÃ¡tico com DLQ
- âœ… ValidaÃ§Ã£o de DTOs
- âœ… Health checks

## ğŸ“ˆ Escalabilidade

- **Consumers Paralelos:** MÃºltiplas instÃ¢ncias podem consumir da mesma fila
- **RabbitMQ Clustering:** Suporta mÃºltiplos nÃ³s
- **PostgreSQL:** Pode ser migrado para ambiente gerenciado
- **Docker Compose:** Ideal para desenvolvimento; use Kubernetes para produÃ§Ã£o

## ğŸ¤ Contribuindo

1. Clone o repositÃ³rio
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudanÃ§as (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

## ğŸ“ LicenÃ§a

Este projeto estÃ¡ sob a licenÃ§a MIT.

---

**Desenvolvido com â¤ï¸ por Henrique**
